<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®¤è¯è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        #log {
            max-height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 10px;
            font-size: 12px;
            border-radius: 3px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
        }
        .log-error { color: #f48771; }
        .log-success { color: #89d185; }
        .log-info { color: #75beff; }
        .log-warning { color: #e9c46a; }
    </style>
</head>
<body>
    <h1>ğŸ” è®¤è¯ä¸WebSocketè°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>1. CookieçŠ¶æ€</h2>
        <div id="cookie-status"></div>
        <button onclick="checkCookies()">æ£€æŸ¥Cookie</button>
        <button onclick="clearCookies()">æ¸…é™¤æ‰€æœ‰Cookie</button>
    </div>
    
    <div class="section">
        <h2>2. è®¤è¯æµ‹è¯•</h2>
        <div id="auth-status"></div>
        <button onclick="testAuth()">æµ‹è¯•è®¤è¯çŠ¶æ€</button>
        <button onclick="initGame()">åˆå§‹åŒ–æ¸¸æˆ</button>
        <button onclick="window.location.href='/api/login/linuxdo'">LinuxDoç™»å½•</button>
    </div>
    
    <div class="section">
        <h2>3. WebSocketæµ‹è¯•</h2>
        <div id="ws-status"></div>
        <button onclick="testWebSocket()">æµ‹è¯•WebSocketè¿æ¥</button>
        <button onclick="closeWebSocket()">å…³é—­WebSocket</button>
    </div>
    
    <div class="section">
        <h2>4. å®æ—¶æ—¥å¿—</h2>
        <div id="log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <div class="section">
        <h2>5. ç³»ç»Ÿä¿¡æ¯</h2>
        <pre id="system-info"></pre>
    </div>

    <script>
        let ws = null;
        const logDiv = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function checkCookies() {
            log('æ£€æŸ¥Cookie...', 'info');
            const cookies = document.cookie.split(';').map(c => c.trim());
            const tokenCookie = cookies.find(c => c.startsWith('token='));
            
            if (tokenCookie) {
                const tokenValue = tokenCookie.split('=')[1];
                const tokenPreview = tokenValue.substring(0, 20) + '...';
                updateStatus('cookie-status', 
                    `âœ… æ‰¾åˆ°token cookie<br>é¢„è§ˆ: ${tokenPreview}<br>å®Œæ•´Cookieåˆ—è¡¨:<br>${cookies.join('<br>')}`, 
                    'success');
                log('æ‰¾åˆ°token cookie', 'success');
            } else {
                updateStatus('cookie-status', 
                    `âŒ æœªæ‰¾åˆ°token cookie<br>å½“å‰Cookie:<br>${cookies.length > 0 ? cookies.join('<br>') : 'æ— '}`, 
                    'error');
                log('æœªæ‰¾åˆ°token cookie', 'error');
            }
        }
        
        function clearCookies() {
            log('æ¸…é™¤æ‰€æœ‰Cookie...', 'warning');
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            updateStatus('cookie-status', 'å·²æ¸…é™¤æ‰€æœ‰Cookie', 'warning');
            log('Cookieå·²æ¸…é™¤', 'success');
        }
        
        async function testAuth() {
            log('æµ‹è¯•è®¤è¯çŠ¶æ€...', 'info');
            try {
                const response = await fetch('/api/test/auth', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (data.authenticated) {
                    updateStatus('auth-status', 
                        `âœ… è®¤è¯æˆåŠŸ<br>ç”¨æˆ·å: ${data.username}<br>ä¿¡ä»»ç­‰çº§: ${data.trust_level}`, 
                        'success');
                    log(`è®¤è¯æˆåŠŸ - ç”¨æˆ·: ${data.username}`, 'success');
                } else {
                    updateStatus('auth-status', 
                        `âŒ è®¤è¯å¤±è´¥<br>åŸå› : ${data.message}`, 
                        'error');
                    log(`è®¤è¯å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                updateStatus('auth-status', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                log(`è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function initGame() {
            log('åˆå§‹åŒ–æ¸¸æˆ...', 'info');
            try {
                const response = await fetch('/api/game/init', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                log(`æ¸¸æˆåˆå§‹åŒ–å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('auth-status', 
                        `âœ… æ¸¸æˆåˆå§‹åŒ–æˆåŠŸ<br>å‰©ä½™æœºä¼š: ${data.opportunities_remaining}`, 
                        'success');
                    log('æ¸¸æˆåˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    const errorText = await response.text();
                    updateStatus('auth-status', 
                        `âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥<br>çŠ¶æ€ç : ${response.status}<br>é”™è¯¯: ${errorText}`, 
                        'error');
                    log(`æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                updateStatus('auth-status', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                log(`æ¸¸æˆåˆå§‹åŒ–å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        async function testWebSocket() {
            log('æµ‹è¯•WebSocketè¿æ¥...', 'info');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                updateStatus('ws-status', 'âš ï¸ WebSocketå·²è¿æ¥', 'warning');
                log('WebSocketå·²ç»è¿æ¥', 'warning');
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;
            
            log(`è¿æ¥åˆ°: ${wsUrl}`, 'info');
            
            try {
                ws = new WebSocket(wsUrl);
                ws.binaryType = 'arraybuffer';
                
                ws.onopen = () => {
                    updateStatus('ws-status', 'âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                    log('WebSocketè¿æ¥æˆåŠŸï¼', 'success');
                };
                
                ws.onmessage = (event) => {
                    let message;
                    if (event.data instanceof ArrayBuffer) {
                        try {
                            // éœ€è¦pakoåº“æ¥è§£å‹
                            log('æ”¶åˆ°äºŒè¿›åˆ¶æ¶ˆæ¯ï¼ˆéœ€è¦è§£å‹ï¼‰', 'info');
                            updateStatus('ws-status', 'æ”¶åˆ°å‹ç¼©æ¶ˆæ¯', 'info');
                        } catch (err) {
                            log(`è§£å‹å¤±è´¥: ${err.message}`, 'error');
                        }
                    } else {
                        message = JSON.parse(event.data);
                        log(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
                        updateStatus('ws-status', `æ”¶åˆ°æ¶ˆæ¯ç±»å‹: ${message.type}`, 'info');
                    }
                };
                
                ws.onerror = (error) => {
                    updateStatus('ws-status', 'âŒ WebSocketè¿æ¥é”™è¯¯', 'error');
                    log('WebSocketé”™è¯¯', 'error');
                };
                
                ws.onclose = (event) => {
                    updateStatus('ws-status', 
                        `âŒ WebSocketå…³é—­<br>ä»£ç : ${event.code}<br>åŸå› : ${event.reason || 'æœªçŸ¥'}`, 
                        'error');
                    log(`WebSocketå…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason}`, 'error');
                };
                
            } catch (error) {
                updateStatus('ws-status', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                log(`WebSocketè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        function closeWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                updateStatus('ws-status', 'WebSocketå·²å…³é—­', 'warning');
                log('WebSocketè¿æ¥å·²å…³é—­', 'warning');
            } else {
                updateStatus('ws-status', 'æ— æ´»åŠ¨çš„WebSocketè¿æ¥', 'info');
                log('æ²¡æœ‰æ´»åŠ¨çš„WebSocketè¿æ¥', 'info');
            }
        }
        
        function showSystemInfo() {
            const info = {
                'æµè§ˆå™¨': navigator.userAgent,
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.host,
                'Cookieå¯ç”¨': navigator.cookieEnabled,
                'å½“å‰è·¯å¾„': window.location.pathname,
                'æ—¶é—´': new Date().toLocaleString()
            };
            
            document.getElementById('system-info').textContent = JSON.stringify(info, null, 2);
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
        window.onload = () => {
            log('è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
            showSystemInfo();
            checkCookies();
            testAuth();
        };
    </script>
</body>
</html>